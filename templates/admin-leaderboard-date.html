{% extends "admin-base.html" %}

{% block content %}
    <div class="jumbotron">
      <div class="container">
        <h1>Day Leaderboard</h1>
        <p>A summary of the CMX leaderboard for a particular day for the walking competition. </p>
      </div>
    </div>

    <div class="container">
        <form class="form-inline" action="/admin-leaderboard-date" method="POST">
            {% if leaderboardform.number_delegates.errors %}
                <ul class="errors">{% for error in leaderboardform.number_delegates.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
            {% if leaderboardform.date.errors %}
                <ul class="errors">{% for error in leaderboardform.date.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
        <div class="input-group">
            {% for subfield in leaderboardform.format %}
                <div class="input-group-addon">
                    {{ subfield}} {{ subfield.label }}
                </div>
            {% endfor %}
            <div class="input-group-addon"><b>Date for leaderboard</b></div>
            {{ leaderboardform.date(class="form-control", placeholder="YYYY-MM-DD", value=date )}}
            <div class="input-group-addon"><b>Number delegates</b></div>
            {{ leaderboardform.number_delegates(class="form-control", placeholder="Number", value=number_delegates)}}
            <span class="input-group-btn">
                <button type="submit" class="btn btn-primary">Run Report</button>
            </span>
        </div>
        </form>
    </div>
{% if format == "table" %}
<div class="container">
      <div class="row">
        <div class="col-md-12">
          <h2>Leaderboard</h2>
          <p>Ordered list of delegates devices and the distance that has been covered.</p>
            <table class="table table-striped">
              <tr>
                  <th>Position</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>MAC</th>
                  <th>Distance</th>
                  <th>Date</th>
              </tr>
              {% if devices_date %}
                  {% for device in devices_date %}
                      <tr>
                          <td>{{loop.index}}</td>
                          <td>{{device.nickname}}</td>
                          <td>{{device.owner}}</td>
                          <td>{{device.mac}}</td>
                          <td>{{'{:,.2f}'.format(device.mtrs)}}</td>
                          <td>{{device.time}}</td>
                      </tr>
                  {% endfor %}
              {% endif %}
            </table>
        </div>
      </div>
</div>

{% endif %}
{% if format == "graph" %}
<div class="container">
    <h2>Leaderboard Graph</h2>
    <p>Ordered list of delegates devices and the distance that has been covered.</p>
    <style>
    body {
        margin: 15px;
        background-color: #F1F3F3
    }
    .bar {
        fill: #2ca25f;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: #D4D8DA;
        stroke-width: 1px;
        shape-rendering: crispEdges;
    }
    .x.axis text {
        font-family: 'Open Sans', sans-serif;
        font-size: 15pxs;
      }
    .axis {
        font: 14px sans-serif;
    }

    .x path {
        display: none;
    }
    div.tooltip {
      position: absolute;
      text-align: center;
      width: 150px;
      height: 60px;
      padding: 5px;
      font: 12px sans-serif;
      background: #e5f5f9;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
    }
    </style>
    <svg width="960" height="1000"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
    var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 200},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;

    var tooltip = d3.select("body").append("div").attr("class", "toolTip");

    var x = d3.scaleLinear().range([0, width]);
    var y = d3.scaleBand().range([height, 0]).padding(0.1);
    var barPadding = 2;

    var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var data = {{ top_devices_json | safe }};

    //sort bars based on value
    data = data.sort(function (a, b) {
        return a.mtrs - b.mtrs;
    });
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    var formatDecimal = d3.format(",")

    var colour = d3.scaleOrdinal(d3.schemeCategory20c);

    console.log(data);

    x.domain([0, d3.max(data, function(d) { return d.mtrs; })]);
    y.domain(data.map(function(d) { return d.nickname; }));

    g.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).ticks(5).tickFormat(function(d) { return formatDecimal(d); }).tickSizeInner([-height]))
        .append("text")
        .attr("x", width / 2)
        .attr("y", margin.bottom * 0.9)
        .attr("dx", "0.32em")
        .attr("fill", "#000")
        .attr("text-anchor", "start")
        .text("Distance Mtrs");

    g.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y));

    g.selectAll(".bar")
        .data(data)
      .enter().append("rect")
        .attr("x", 0)
        .attr("height", y.bandwidth())
        .attr("y", function(d) { return y(d.nickname); })
        .attr("width", function(d) { return x(d.mtrs); })
        .attr("fill", function (d){ return colour(d.nickname); })
        .on("mouseover", function(d){
            div.transition()
                .duration(200)
                .style("opacity", .9);
            div.html("Email:" + (d.nickname) + "<br>" + "MAC:" + (d.mac) + "<br>" + "Mtrs:" + (formatDecimal(d.mtrs)))
              .style("left", d3.event.pageX - 50 + "px")
              .style("top", d3.event.pageY - 70 + "px");
            })
        .on("mouseout", function(d){
            div.transition()
                .duration(500)
                .style("opacity", 0);
        });

    </script>
{% endif %}
{% endblock %}